FROM nvidia/cuda:12.1.1-devel-ubuntu22.04

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1 \
    DATA_ROOT=/app/data \
    CELERY_BROKER_URL=redis://redis:6379/0 \
    CELERY_RESULT_BACKEND=redis://redis:6379/1 \
    DEBIAN_FRONTEND=noninteractive \
    PYTHONPATH=/app \
    CUDA_HOME=/usr/local/cuda \
    TORCH_CUDA_ARCH_LIST="6.0;6.1;7.0;7.5;8.0;8.6;9.0"

# ì‹œìŠ¤í…œ ì˜ì¡´ì„± ì„¤ì¹˜
RUN apt-get update && apt-get install -y \
    python3.10 \
    python3.10-dev \
    python3-pip \
    git \
    wget \
    curl \
    build-essential \
    ninja-build \
    && rm -rf /var/lib/apt/lists/*

# Python ê¸°ë³¸ ì„¤ì •
RUN ln -s /usr/bin/python3.10 /usr/bin/python
RUN python -m pip install --upgrade pip

WORKDIR /app

# PyTorch GPU ë²„ì „ ì„¤ì¹˜ (CUDA 12.1)
RUN pip install torch==2.3.1 torchvision==0.18.1 torchaudio==2.3.1 --index-url https://download.pytorch.org/whl/cu121

# MedSAM2 ì˜ì¡´ì„± ì„¤ì¹˜
COPY medsam_api_server/requirements.txt /app/requirements.txt
RUN pip install --no-cache-dir -r /app/requirements.txt

# MedSAM2 ì†ŒìŠ¤ ë³µì‚¬ (ë¹Œë“œ ì‹œì ì—)
COPY MedSAM2 /app/MedSAM2

# MedSAM2 ì„¤ì¹˜ (ë¹Œë“œ ì‹œì ì—)
WORKDIR /app/MedSAM2
RUN pip install numpy setuptools wheel --quiet && \
    pip install -e . --quiet || \
    (echo "âš ï¸ CUDA extensions failed, trying without..." && \
     FORCE_CUDA=0 pip install -e . --quiet)

# API ì„œë²„ ì½”ë“œ ë³µì‚¬
WORKDIR /app
COPY medsam_api_server /app/medsam_api_server

# ë°ì´í„° ë° ëª¨ë¸ ë””ë ‰í† ë¦¬ ìƒì„±
RUN mkdir -p /app/data /app/models /app/temp

# ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ìŠ¤í¬ë¦½íŠ¸ (ë‚˜ì¤‘ì— ì‹¤í–‰)
COPY scripts/download_models.sh /app/scripts/
RUN chmod +x /app/scripts/download_models.sh

EXPOSE 8000

# í—¬ìŠ¤ì²´í¬ ì¶”ê°€
HEALTHCHECK --interval=30s --timeout=30s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1

# ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
RUN cat > /app/start_server.sh << 'EOF'
#!/bin/bash
set -e

echo "ğŸš€ Starting MedSAM2 GPU Service..."
echo "Working directory: $(pwd)"
echo "Python path: $PYTHONPATH"
echo "CUDA_HOME: $CUDA_HOME"

# MedSAM2ëŠ” ë¹Œë“œ ì‹œì ì— ì´ë¯¸ ì„¤ì¹˜ë¨
echo "ğŸ“¦ MedSAM2 already installed during build"

# Python ëª¨ë“ˆ í™•ì¸
echo "ğŸ” Checking Python modules..."
python -c "import medsam_api_server; print('âœ… medsam_api_server module found')" || echo "âŒ medsam_api_server module not found"

# sam2 ëª¨ë“ˆ í™•ì¸
python -c "import sam2; print('âœ… sam2 module found')" 2>/dev/null || echo "âš ï¸ sam2 module not available - API will run in limited mode"

echo "ğŸŒ Starting API server..."
cd /app
uvicorn medsam_api_server.main:app --host 0.0.0.0 --port 8000
EOF

RUN chmod +x /app/start_server.sh

CMD ["/app/start_server.sh"]
